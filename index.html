<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Senter & Pencari Google</title>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; color: #555; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; text-align: center; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        #status { font-size: 1.2rem; padding: 20px; }
        #status span { color: #888; font-weight: bold; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="status">Ketuk layar untuk memulai dan memberikan izin kamera.</div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "%VITE_FIREBASE_API_KEY%",
          authDomain: "%VITE_FIREBASE_AUTH_DOMAIN%",
          projectId: "%VITE_FIREBASE_PROJECT_ID%",
          storageBucket: "%VITE_FIREBASE_STORAGE_BUCKET%",
          messagingSenderId: "%VITE_FIREBASE_MESSAGING_SENDER_ID%",
          appId: "%VITE_FIREBASE_APP_ID%"
        };

        const statusDiv = document.getElementById('status');
        let hasPermissionBeenGranted = false;
        let isTorchOn = false;
        let mediaStreamTrack = null;
        let isExecutingSequence = false;

        // --- BARU: Helper untuk mengambil nilai nested dari JSON ---
        const getNestedValue = (obj, path) => {
            return path.split('.').reduce((acc, part) => acc && acc[part], obj);
        };
        
        // --- BARU: Fungsi untuk fetch data dari API ---
        const fetchDataFromApi = async (url, key) => {
            updateStatus('<div class="spinner"></div>Mengambil data dari API...');
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Status HTTP: ${response.status}`);
                const data = await response.json();
                const value = getNestedValue(data, key);

                if (value !== undefined && value !== null) {
                    updateStatus(`Data API diterima: <span>${value}</span>`);
                    return String(value);
                } else {
                    updateStatus(`Error: Key <span>'${key}'</span> tidak ditemukan di API.`);
                    return null;
                }
            } catch (error) {
                console.error("API Fetch Error:", error);
                updateStatus("Gagal mengambil data dari API.");
                return null;
            }
        };

        const requestPermission = async () => {
            if (hasPermissionBeenGranted) return;
            updateStatus("Meminta izin kamera...");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                stream.getTracks().forEach(track => track.stop());
                hasPermissionBeenGranted = true;
                updateStatus("Izin diberikan. Menghubungkan ke Firestore...");
                initializeFirebaseListener();
            } catch (err) {
                updateStatus("Izin kamera ditolak. Aplikasi tidak dapat berfungsi.");
            }
        };

        const initializeFirebaseListener = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);

                const controlSignalRef = doc(db, 'control', 'signal');
                updateStatus("Terhubung. Menunggu instruksi...");

                // --- LOGIKA UTAMA YANG DIUBAH ---
                onSnapshot(controlSignalRef, async (docSnap) => {
                    if (isExecutingSequence) return;
                    if (!docSnap.exists()) return updateStatus("Dokumen 'signal' tidak ditemukan.");

                    const data = docSnap.data();
                    const flashCommand = data.flashStatus;
                    let searchQuery = null;

                    // Tentukan query berdasarkan sumber data
                    if (data.source === 'manual') {
                        searchQuery = data.value || null;
                    } else if (data.source === 'api' && data.apiUrl && data.apiKey) {
                        // Aplikasi senter sekarang yang melakukan fetch
                        searchQuery = await fetchDataFromApi(data.apiUrl, data.apiKey);
                    }

                    // Jalankan sekuens senter, lalu arahkan pencarian jika ada query
                    if (flashCommand) {
                        await executeCommandSequence(flashCommand, searchQuery);
                    }
                });
            } catch (error) {
                updateStatus("Gagal terhubung ke server.");
            }
        };

        const executeCommandSequence = async (sequence, searchQuery) => {
            isExecutingSequence = true;
            const commands = sequence.split(',');

            for (const cmd of commands) {
                const command = cmd.trim().toLowerCase();
                if (command === 'on') await toggleTorch(true);
                else if (command === 'off') await toggleTorch(false);
                else {
                    const delay = parseInt(command, 10);
                    if (!isNaN(delay)) {
                        updateStatus(`Jeda selama <span>${delay}</span> ms...`);
                        await sleep(delay);
                    }
                }
            }

            // Setelah sekuens senter, lakukan pencarian jika searchQuery valid
            if (searchQuery && typeof searchQuery === 'string' && searchQuery.trim() !== '') {
                const cleanedQuery = searchQuery.trim();
                updateStatus(`Mengarahkan ke pencarian Google untuk: <span>${cleanedQuery}</span>`);
                const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(cleanedQuery)}`;
                await sleep(1500);
                window.location.replace(searchUrl);
            } else {
                isExecutingSequence = false;
                updateStatus("Selesai. Menunggu instruksi berikutnya...");
            }
        };

        const toggleTorch = async (turnOn) => { /* ... (fungsi toggleTorch tidak berubah) ... */ 
            if (turnOn === isTorchOn) return;
            updateStatus(turnOn ? "Senter: <span>ON</span>" : "Senter: <span>OFF</span>");
            try {
                if (turnOn) {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    mediaStreamTrack = stream.getVideoTracks()[0];
                    await mediaStreamTrack.applyConstraints({ advanced: [{ torch: true }] });
                    isTorchOn = true;
                } else {
                    if (mediaStreamTrack) {
                        mediaStreamTrack.stop();
                        mediaStreamTrack = null;
                    }
                    isTorchOn = false;
                }
            } catch (err) {
                updateStatus("Gagal mengubah status senter.");
            }
        };

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
        const updateStatus = (message) => { statusDiv.innerHTML = message; };

        document.documentElement.addEventListener('click', requestPermission, { once: true });
    </script>
</body>
</html>